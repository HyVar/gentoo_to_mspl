# hyvar for reconfiguring gentoo

Structure of the repository:

* guest: contains the script to save in the gentoo VM

* host: contains the code needed for the translation and computation of the new configuration
   - portage
      * portage.tar.bz2: copied from guest
      * usr: generated by uncompress-portage.sh
      * json
         1. mspl: generated by uncompress-portage.sh
         2. spl: generated by uncompress-portage.sh
         3. hyvarrec: generated by ....
   - configuration:
      * configuration.gz: copied from guest
      * world.gz: copied from guest 
      * json
         1. configuration.json: generated by uncompress-configuration.sh (current configuration)
         2. world: generated by uncompress-configuration.sh (this is the concatenation of user requests)
   - scripts: directory containing ulitity scripts and src 
   - uncompress-portage.sh
   - uncompress-configuration.sh
   - portage2hyvarrec.sh
   - run-hyvarrec.sh
      
How to prepare the VM 
----------------------
Tor this example we consider the Gentoo VM available from https://www.osboxes.org/gentoo/

In particular the system was tested with Gentoo 201703 (CLI Minimal) - 64bit.

Our script will use ssh to connect to the VM. For this reason sshd demon needs to be started on the VM.
To do so please make sure that sshd is started and if not run the following command.
```
sudo service sshd start
```

Note that the credential to use the VM are the following.
``` 
Username: osboxes
Password: osboxes.org
Password for Root account: osboxes.org
```

To access the machine for the remaing of the running example we assume that it could be reached with the ssh protocol
at port 9022 (if VirtualBox is used this can be configured with a port forwarding).
Please verity to have access to the VM. As example this can be obtained as follows.
```
ssh -p 9022 -o PubkeyAuthentication=no osboxes@localhost
```

If the VM is reachable then run the following command that will install the necessary script in the VM and configurint 
portage to be in testing mode.
```
sh setup-guest.sh osboxes@localhost 9022
```



Getting data from the VM 
----------------------

To get the required information from the VM please run the following scripts.
```
sh get-configuration.sh osboxes@localhost 9022
sh get-portage.sh osboxes@localhost 9022
```

Note that this script for safety does not override existing data.
Please run the following script to delete local data TODO

The get-portage.sh script translates all the portage structure and it may take a lot of time (possibly hours).
However, this script needs to be executed only the portage tree is updated (previous the execution of the cleanup
scrip).

Reconfigure
----------------------

To run the reconfiguration run the following script.
```
sh reconfigure <request file> <keyword>
```

For example, to install git execute the following script.
```
sh reconfigure world amd64
```
where the world file is the following JSON file.
```
{
	"app-admin/sudo":{},
	"app-admin/syslog-ng":{},
	"sys-apps/dbus":{},
	"sys-boot/grub":{},
	"sys-kernel/genkernel":{},
	"sys-kernel/gentoo-sources":{},
	"dev-vcs/git":{}
}
```

Updating the VM
----------------------
To update the VM run the following script.
```
sh update-guest.sh osboxes@localhost 9022
```
This script move to the VM in the user home folder the installation script update.sh and set the configuration file
for the packages. The update script needs to be run on the VM by the user as follows.
```
sudo update.sh
```


Assumptions
----------------------
Packages installed that are not in the portage tree are not considered (working in progress).

User can impose either constraint on slot + subslot or package versions when requiring packages.

We work on testing mode of portage (e.g., we treat ~amd64 as amd64)

Package that are always visible (**) are treated as packages visible if they are stable on any architecture (*)

When the keyword is not specified for a package we do not install it


TODO:
------------------------ 
 sys-apps/kbd-2.0.3 can not be disinstalled
 
 makefile that will clean and all operations
 
 amd64 as default in script sh setup-guest.sh
 
 Both: change world structure file to allow user to disinstall packages + extend capabilities (version,slots)
 
 Michael: correct generation of world from gentoo also translating the profile in hyvarrec
 
 Michael:  (packages are not separted by space for jacopo)
 The constraint in md5-cache are well translated (new lines and commas)
 
 Michael: refactor of the translation

 Michael: handle the deprecated packages after an update
 
 Jacopo: remove slot o subslot variables in encoding
 
 Jacopo: install world of kde version into minimal gentoo version and check what happens
 
 Jacopo: incrementality of translation into hyvarrec
 
 Jacopo: try to unify both parsing of dependencies (talk with Michael)
 
 Michael: contact gentoo community

 
Task:
------------------------ 
Find configuration from wichi installing something can not be done in portage easily

